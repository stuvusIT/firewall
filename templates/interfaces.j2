# vim: sw=4 ts=4 ft=jinja
# {{ ansible_managed }}

{% if network_management_pre_up is defined %}
post_up {{ network_management_pre_up }}

{% endif %}

auto lo
iface lo inet loopback

{% if network_management_clear_bridges %}
# Delete all network bridges
pre-up for br in `ovs-vsctl list-br`; do ovs-vsctl --if-exists "$br"; done
{% endif %}

################################################################################
# Configure all network interfaces                                             #
################################################################################
{% for interface in interfaces %}
{% if interface.bring_up|default(network_management_default_bring_up) %}
auto {{ interface.name }}
{% endif -%}

iface {{ interface.name }} inet {{ interface.type|default(network_management_default_type) }}
{% if interface.type|default(network_management_default_type) == "dhcp" %}
	hostname {{ interface.hostname|default(ansible_hostname) }}
	{% if interface.leasetime is defined %}leasetime {{ interface.leasetime }}{% endif %}
	{% if interface.metric is defined %}metric {{ interface.metric }}{% endif %}
{% elif interface.type|default(network_management_default_type) == "static" or interface.type|default(network_management_default_type) == "manual" -%}

{% for ip in interface.ips %}
	{% if not loop.first %}

iface {{ interface.name }} inet {{ interface.type|default(network_management_default_type) }}
	{% endif -%}
	address {{ ip | ipaddr('address') }}
	network {{ ip | ipaddr('network') }}
	netmask {{ ip | ipaddr('netmask') }}
{% endfor %}
{% endif %}
	dns-nameservers{% for nameserver in interface.nameservers|default(network_management_nameservers) %} {{ nameserver|ipaddr('address') }}{% endfor %}{# for loop, to allow ipaddr filter usage #}


{% endfor %}

################################################################################
# Configure all network bridges                                                #
################################################################################
# Bring up all ports for all bridges
{% for bridge in bridges %}
{% for port in interface.ports | default({}) %}
auto {{ port.port }}
iface {{ port.port }} inet manual

{% endfor %}
{% endfor %}

# Bring all openvswitch bridges up and configure ovs
{% for interface in bridges %}
auto {{ interface.name }}
{% if interface.type | default(network_management_default_type) == "dhcp"%}
iface {{ interface.name }} inet dhcp
	hostname {{ interface.hostname|default(ansible_hostname) }}
	{% if interface.leasetime is defined %}leasetime {{ interface.leasetime }}{% endif %}
	{% if interface.metric is defined %}metric {{ interface.metric }}{% endif %}
{% elif interface.type | default(network_management_default_type) == "static" %}
iface {{ interface.name }} inet static
	address {{ interface.static[0] | ipaddr('address') }}
	network {{ interface.static[0] | ipaddr('network') }}
	netmask {{ interface.static[0] | ipaddr('netmask') }}
{% if interface.broadcast is defined %}
	broadcast {{ interface.broadcast }}
{% endif %}
{% if interface.gateway is defined %}
	gateway {{ interface.gateway|ipaddr('address') }}
{% endif %}
{% if interface.search is defined %}
	dns-search {{ interface.search }}
{% endif %}
{% if interface.nameservers is defined %}
	dns-nameservers{% for nameserver in interface.nameservers %} {{ nameserver|ipaddr('address') }}{% endfor %}{# for loop, to allow ipaddr filter usage #}

{% endif %}
{% else %}
iface {{ interface.name }} inet manual
{% endif %}
	pre-up    ovs-vsctl --may-exist add-br {{ interface.name }}{% if interface.parent is defined %} {{ interface.parent }} {{ interface.vlan }}{% endif %}

{% for port in interface.ports | default({}) %}
	pre-up    ovs-vsctl --may-exist add-port {{ interface.name }} {{ port.port }}{% if port.vlan is defined %} tag={{ port.vlan }}{% endif %}

{% endfor %}
{% if interface.post_up is defined %}
	post-up {{ interface.post_up }}
{% endif %}
{% for port in interface.ports | default({}) %}
	pre-down  ovs-vsctl --if-exists del-port {{ interface.name }} {{ port.port }}
{% endfor %}
	post-down ovs-vsctl --if-exists del-br {{ interface.name }}

{% if interface.static is defined %}{% for static_ip in interface.static %}{% if not loop.first %}{#add all but first static ip addresses#}
iface {{ interface.name }} inet static
	address {{ static_ip | ipaddr('address') }}
	netmask {{ static_ip | ipaddr('netmask') }}
{% if interface.post_up %}
	post-up {{ interface.post_up }}
{% endif %}
{% endif %}{% endfor %}{% endif %}

{% endfor %}
{% if patch_field is defined %}

{% for patch_field_dev_in, patch_field_dev_out in patch_field.iteritems() %}
post-up ovs-vsctl {{''
	-}} --may-exist add-port {{ patch_field_dev_in }} {{ patch_field_dev_in }}_patch_{{ loop.index }} -- {{''
	-}} set interface {{ patch_field_dev_in }}_patch_{{ loop.index }} type=patch options:peer={{ patch_field_dev_out }}_patch_{{ loop.index }} -- {{''
	-}} --may-exist add-port {{ patch_field_dev_out }} {{ patch_field_dev_out }}_patch_{{ loop.index }} -- {{''
	-}} set interface {{ patch_field_dev_out }}_patch_{{ loop.index }} type=patch options:peer={{ patch_field_dev_in }}_patch_{{ loop.index }}; true
{% endfor %}
{% endif %}
{% if network_management_default_gateway is defined %}


post-up ip r replace default via {{ network_management_default_gateway }}
{% endif %}
{% if network_management_post_up is defined %}
post_up {{ network_management_post_up }}
{% endif %}
